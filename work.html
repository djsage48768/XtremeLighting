<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Issue Parts to Job – QR Scan</title>

<style>
:root{
  --ok:#107c10;
  --warn:#ff8c00;
  --err:#d13438;
  --bg:#f7f7f7;
  --card:#fff;
}

body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
}

header{
  padding:10px 14px;
  background:#0f6cbd;
  color:#fff;
  display:flex;
  gap:12px;
  align-items:center;
}

.card{
  background:#fff;
  margin:14px;
  border-radius:10px;
  padding:12px;
  box-shadow:0 1px 3px rgba(0,0,0,.06);
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal .box{
  background:#000;
  color:#fff;
  border-radius:10px;
  width:95%;
  max-width:720px;
  overflow:hidden;
}

.modal header{
  padding:8px;
  background:#111;
}

video{
  width:100%;
  background:#000;
}

.modal footer{
  padding:8px;
  background:#111;
  display:flex;
  gap:8px;
}

#scanMsg{ margin-top:6px; font-weight:bold; }
</style>
</head>
<body>

<header>
  <h1>Issue Parts to Job – QR Scan</h1>
</header>

<div class="card">
  <label>Job</label>
  <input id="jobInput">
  <button id="jobCamBtn">Scan Job</button>
</div>

<div class="card">
  <label>Scan Part</label>
  <input id="scanInput">
  <button id="partCamBtn">Scan Part</button>
  <div id="scanMsg"></div>
</div>

<div class="modal" id="camModal">
  <div class="box">
    <header>Scan</header>
    <video id="cam" playsinline autoplay muted></video>
    <footer>
      <button id="closeCam">Close</button>
    </footer>
  </div>
</div>

<!-- ZXing UMD will be embedded here by Pack-Scanner-SingleFile.ps1 -->
<script>
const ZXING_UMD = `/*__ZXING_UMD_PLACEHOLDER__*/`;
</script>

<script>
const $ = id => document.getElementById(id);

let scanMode='job';
let activeStream=null;
let zxingReader=null;
let zxingControls=null;

function toast(msg){
  $('scanMsg').textContent=msg;
  setTimeout(()=> $('scanMsg').textContent='',2000);
}

async function loadZXingEmbedded(){
  if(window.ZXingBrowser || window.ZXing) return;
  const s=document.createElement('script');
  s.type='text/javascript';
  s.text = ZXING_UMD; // defines window.ZXingBrowser or window.ZXing
  document.head.appendChild(s);
  await new Promise(r=>setTimeout(r,0));
}

$('jobCamBtn').onclick=()=>openScanner('job');
$('partCamBtn').onclick=()=>openScanner('part');
$('closeCam').onclick=stopScanner;

async function openScanner(mode){
  scanMode=mode;

  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    alert('Camera requires HTTPS.');
    return;
  }

  $('camModal').style.display='flex';

  try{
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}}
    });

    activeStream=stream;

    const video=$('cam');
    video.srcObject=stream;
    video.muted=true;
    video.setAttribute('playsinline',true);

    await video.play();

  }catch(e){
    console.error('Camera permission error:',e);
    alert('Camera permission denied.');
    return;
  }

  try{
    await loadZXingEmbedded();
    const ZX = window.ZXingBrowser || window.ZXing;
    if(!ZX) throw new Error('ZXing not available');

    if(!zxingReader){
      const Reader = ZX.BrowserMultiFormatReader || ZX.BrowserQRCodeReader;
      zxingReader=new Reader();
    }

    // Prefer decode from video element (UMD API supports this)
    zxingControls = zxingReader.decodeFromVideoElement(
      $('cam'),
      (result,err)=>{
        if(result){
          const text = result.getText ? result.getText() : (result.text || String(result));
          handleDecoded(text);
        }
      }
    );

  }catch(e){
    console.error('ZXing init error:',e);
    alert('Scanner failed to initialize.');
  }
}

function stopScanner(){
  $('camModal').style.display='none';

  if(zxingControls){
    try{ zxingControls.stop(); }catch{}
    zxingControls=null;
  }

  if(activeStream){
    activeStream.getTracks().forEach(t=>t.stop());
    activeStream=null;
  }
}

function handleDecoded(text){
  stopScanner();

  if(scanMode==='job'){
    $('jobInput').value=text;
  }else{
    toast('Scanned: '+text);
  }
}
</script>
</body>
</html>
