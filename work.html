<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Issue Parts to Job â€“ QR Scan</title>

<style>
:root{
  --ok:#107c10;
  --warn:#ff8c00;
  --err:#d13438;
  --bg:#f7f7f7;
  --card:#fff;
}

*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:var(--bg);
  -webkit-font-smoothing:antialiased;
  -webkit-tap-highlight-color:transparent;
  padding-top:env(safe-area-inset-top);
  padding-bottom:env(safe-area-inset-bottom);
}

header{
  padding:16px;
  padding-top:calc(16px + env(safe-area-inset-top));
  background:#0f6cbd;
  color:#fff;
  display:flex;
  gap:12px;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}

h1{
  font-size:20px;
  margin:0;
  font-weight:600;
}

.card{
  background:#fff;
  margin:16px;
  border-radius:12px;
  padding:16px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}

label{
  display:block;
  font-size:15px;
  font-weight:600;
  margin-bottom:8px;
  color:#333;
}

input{
  width:100%;
  padding:12px;
  font-size:16px;
  border:1px solid #d1d1d6;
  border-radius:8px;
  margin-bottom:12px;
  background:#fff;
  -webkit-appearance:none;
}

input:focus{
  outline:none;
  border-color:#0f6cbd;
}

button{
  width:100%;
  padding:14px;
  font-size:16px;
  font-weight:600;
  border:none;
  border-radius:8px;
  background:#0f6cbd;
  color:#fff;
  cursor:pointer;
  -webkit-appearance:none;
  touch-action:manipulation;
  user-select:none;
}

button:active{
  opacity:0.8;
  transform:scale(0.98);
}

#scanMsg{
  margin-top:12px;
  padding:12px;
  border-radius:8px;
  background:#e8f5e9;
  color:#2e7d32;
  font-size:15px;
  text-align:center;
  display:none;
}

#scanMsg.show{
  display:block;
}

#scanMsg.error{
  background:#ffebee;
  color:#c62828;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal.show{
  display:flex;
}

.modal .box{
  background:#000;
  color:#fff;
  border-radius:16px;
  width:100%;
  height:100%;
  max-width:500px;
  max-height:90vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  margin:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

.modal header{
  padding:16px;
  background:#1a1a1a;
  font-size:18px;
  font-weight:600;
  position:static;
  flex-shrink:0;
}

#reader{
  flex:1;
  position:relative;
  background:#000;
  overflow:hidden;
}

.modal footer{
  padding:16px;
  background:#1a1a1a;
  display:flex;
  gap:12px;
  flex-shrink:0;
}

.modal footer button{
  background:#fff;
  color:#000;
}

#debugLog{
  margin:16px;
  padding:12px;
  background:#fff3cd;
  border-radius:8px;
  font-size:11px;
  font-family:monospace;
  max-height:300px;
  overflow-y:auto;
  white-space:pre-wrap;
  word-break:break-word;
}

@media(max-width:375px){
  h1{
    font-size:18px;
  }
}
</style>
</head>
<body>

<header>
  <h1>Issue Parts to Job â€“ QR Scan</h1>
</header>

<div id="debugLog">Debug Log (scroll down after clicking scan)...</div>

<div class="card">
  <label>Job</label>
  <input id="jobInput" type="text" placeholder="Scan or enter job number" autocomplete="off">
  <button id="jobCamBtn">ðŸ“· Scan Job QR Code</button>
</div>

<div class="card">
  <label>Part</label>
  <input id="scanInput" type="text" placeholder="Scan or enter part number" autocomplete="off">
  <button id="partCamBtn">ðŸ“· Scan Part QR Code</button>
  <div id="scanMsg"></div>
</div>

<div class="modal" id="camModal">
  <div class="box">
    <header>Scanning QR Code</header>
    <div id="reader"></div>
    <footer>
      <button id="closeCam">Cancel</button>
    </footer>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
const $ = id => document.getElementById(id);

let scanMode='job';
let html5QrcodeScanner = null;
let debugMessages = [];

function addDebug(msg){
  console.log(msg);
  debugMessages.push(new Date().toLocaleTimeString() + ': ' + msg);
  const log = $('debugLog');
  log.textContent = debugMessages.join('\n');
  log.scrollTop = log.scrollHeight;
}

function toast(msg, isError = false){
  const el = $('scanMsg');
  el.textContent=msg;
  el.classList.add('show');
  if(isError){
    el.classList.add('error');
  } else {
    el.classList.remove('error');
  }
  setTimeout(()=> {
    el.classList.remove('show');
  },5000);
}

// Capture all console errors
window.onerror = function(msg, url, line, col, error) {
  addDebug('WINDOW ERROR: ' + msg + ' at line ' + line);
  if(error) addDebug('Error object: ' + error.toString());
  return false;
};

// Capture promise rejections
window.onunhandledrejection = function(event) {
  addDebug('UNHANDLED REJECTION: ' + event.reason);
};

$('jobCamBtn').onclick=()=>openScanner('job');
$('partCamBtn').onclick=()=>openScanner('part');
$('closeCam').onclick=stopScanner;

$('camModal').onclick=(e)=>{
  if(e.target === $('camModal')){
    stopScanner();
  }
};

async function openScanner(mode){
  scanMode=mode;
  
  addDebug('========================================');
  addDebug('Opening scanner for: ' + mode);
  addDebug('Protocol: ' + location.protocol);
  addDebug('Hostname: ' + location.hostname);
  addDebug('User agent: ' + navigator.userAgent);

  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    toast('Camera requires HTTPS or localhost.', true);
    addDebug('ERROR: Not HTTPS');
    return;
  }

  // Check if getUserMedia is available
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    toast('Camera not supported on this browser.', true);
    addDebug('ERROR: getUserMedia not available');
    addDebug('navigator.mediaDevices exists: ' + !!navigator.mediaDevices);
    return;
  }
  
  addDebug('getUserMedia is available');

  $('camModal').classList.add('show');
  addDebug('Modal opened');

  try{
    addDebug('Checking if Html5Qrcode is defined: ' + (typeof Html5Qrcode));
    
    if(typeof Html5Qrcode === 'undefined'){
      throw new Error('Html5Qrcode library not loaded');
    }
    
    addDebug('Creating Html5Qrcode instance...');
    html5QrcodeScanner = new Html5Qrcode("reader");
    addDebug('Html5Qrcode created successfully');
    addDebug('Scanner object type: ' + typeof html5QrcodeScanner);
    addDebug('Scanner has start method: ' + (typeof html5QrcodeScanner.start === 'function'));
    
    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0,
      disableFlip: false
    };

    addDebug('Starting scanner with config...');
    addDebug('Config: ' + JSON.stringify(config));

    const startPromise = html5QrcodeScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
        addDebug('SUCCESS: Decoded: ' + decodedText);
        handleDecoded(decodedText);
      },
      (errorMessage) => {
        // Silent - these happen constantly while scanning
      }
    );
    
    addDebug('Start method called, waiting for promise...');
    await startPromise;
    addDebug('Scanner started successfully!');

  } catch(err) {
    addDebug('========================================');
    addDebug('CATCH BLOCK ENTERED');
    addDebug('Error type: ' + typeof err);
    addDebug('Error toString: ' + err.toString());
    addDebug('Error name: ' + (err.name || 'no name'));
    addDebug('Error message: ' + (err.message || 'no message'));
    
    if(err.stack){
      addDebug('Error stack: ' + err.stack.substring(0, 500));
    }
    
    stopScanner();
    
    let userMsg = 'Scanner failed: ';
    
    if(err.toString().includes('NotAllowedError') || err.name === 'NotAllowedError'){
      userMsg = 'Camera permission denied. Enable in Settings > Safari > Camera.';
    } else if(err.toString().includes('NotFoundError') || err.name === 'NotFoundError'){
      userMsg = 'No camera found on device.';
    } else if(err.toString().includes('NotReadableError') || err.name === 'NotReadableError'){
      userMsg = 'Camera in use by another app.';
    } else if(err.toString().includes('OverconstrainedError') || err.name === 'OverconstrainedError'){
      userMsg = 'Camera constraints not supported.';
    } else {
      userMsg += (err.message || err.toString());
    }
    
    addDebug('Showing user message: ' + userMsg);
    toast(userMsg, true);
  }
}

function stopScanner(){
  addDebug('Stopping scanner...');
  
  if(html5QrcodeScanner){
    html5QrcodeScanner.stop().then(() => {
      addDebug('Scanner stopped');
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
      $('camModal').classList.remove('show');
    }).catch(err => {
      addDebug('Stop error: ' + err.toString());
      html5QrcodeScanner = null;
      $('camModal').classList.remove('show');
    });
  } else {
    addDebug('No scanner to stop');
    $('camModal').classList.remove('show');
  }
}

function handleDecoded(text){
  addDebug('Handling decoded text: ' + text);
  
  if(navigator.vibrate){
    navigator.vibrate(100);
  }
  
  stopScanner();

  if(scanMode==='job'){
    $('jobInput').value=text;
    toast("âœ“ Job scanned: "+text);
  }else{
    $('scanInput').value=text;
    toast("âœ“ Part scanned: "+text);
  }
}

document.addEventListener('dblclick', (e) => {
  e.preventDefault();
}, { passive: false });

// Log page load
addDebug('Page loaded successfully');
addDebug('Html5Qrcode library check: ' + (typeof Html5Qrcode !== 'undefined' ? 'LOADED' : 'NOT LOADED'));
</script>

</body>
</html>
