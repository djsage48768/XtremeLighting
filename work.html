<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Issue Parts to Job – QR Scan</title>

<style>
:root{
  --ok:#107c10;
  --warn:#ff8c00;
  --err:#d13438;
  --bg:#f7f7f7;
  --card:#fff;
}

body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
}

header{
  padding:10px 14px;
  background:#0f6cbd;
  color:#fff;
  display:flex;
  gap:12px;
  align-items:center;
}

.card{
  background:#fff;
  margin:14px;
  border-radius:10px;
  padding:12px;
  box-shadow:0 1px 3px rgba(0,0,0,.06);
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal .box{
  background:#000;
  color:#fff;
  border-radius:10px;
  width:95%;
  max-width:720px;
  overflow:hidden;
}

.modal header{
  padding:8px;
  background:#111;
}

video{
  width:100%;
  background:#000;
}

.modal footer{
  padding:8px;
  background:#111;
  display:flex;
  gap:8px;
}
</style>
</head>
<body>

<header>
  <h1>Issue Parts to Job – QR Scan</h1>
</header>

<div class="card">
  <label>Job</label>
  <input id="jobInput">
  <button id="jobCamBtn">Scan Job</button>
</div>

<div class="card">
  <label>Scan Part</label>
  <input id="scanInput">
  <button id="partCamBtn">Scan Part</button>
  <div id="scanMsg"></div>
</div>

<div class="modal" id="camModal">
  <div class="box">
    <header>Scan</header>
    <video id="cam" playsinline muted></video>
    <footer>
      <button id="closeCam">Close</button>
    </footer>
  </div>
</div>
<script>
const $ = id => document.getElementById(id);

let scanMode='job';
let activeStream=null;
let zxingReader=null;
let zxingControls=null;

function toast(msg){
  $('scanMsg').textContent=msg;
  setTimeout(()=> $('scanMsg').textContent='',2000);
}

function loadZXing(){
  return new Promise((resolve,reject)=>{
    if(window.ZXing){ resolve(); return; }
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js";
    s.onload=resolve;
    s.onerror=reject;
    document.body.appendChild(s);
  });
}

$('jobCamBtn').onclick=()=>openScanner('job');
$('partCamBtn').onclick=()=>openScanner('part');
$('closeCam').onclick=stopScanner;

async function openScanner(mode){
  scanMode=mode;

  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    alert('Camera requires HTTPS.');
    return;
  }

  $('camModal').style.display='flex';

  try{
    // MUST request camera immediately (Safari rule)
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}}
    });

    activeStream=stream;

    const video=$('cam');
    video.srcObject=stream;
    video.muted=true;
    video.setAttribute('playsinline',true);

    await video.play();

  }catch(e){
    console.error("Camera permission error:",e);
    alert("Camera permission denied.");
    return;
  }

  try{

    await loadZXing();

    if(!zxingReader){
      zxingReader=new ZXing.BrowserMultiFormatReader();
    }

    zxingControls=zxingReader.decodeFromVideoElement(
      $('cam'),
      (result,err)=>{
        if(result){
          handleDecoded(result.getText());
        }
      }
    );

  }catch(e){
    console.error("ZXing init error:",e);
    alert("Scanner failed to initialize.");
  }
}

function stopScanner(){
  $('camModal').style.display='none';

  if(zxingControls){
    zxingControls.stop();
    zxingControls=null;
  }

  if(activeStream){
    activeStream.getTracks().forEach(t=>t.stop());
    activeStream=null;
  }
}

function handleDecoded(text){
  stopScanner();

  if(scanMode==='job'){
    $('jobInput').value=text;
  }else{
    toast("Scanned: "+text);
  }
}
</script>