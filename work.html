<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Issue Parts to Job â€“ QR Scan</title>

<style>
:root{
  --ok:#107c10;
  --warn:#ff8c00;
  --err:#d13438;
  --bg:#f7f7f7;
  --card:#fff;
}

*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:var(--bg);
  -webkit-font-smoothing:antialiased;
  -webkit-tap-highlight-color:transparent;
  padding-top:env(safe-area-inset-top);
  padding-bottom:env(safe-area-inset-bottom);
}

header{
  padding:16px;
  padding-top:calc(16px + env(safe-area-inset-top));
  background:#0f6cbd;
  color:#fff;
  display:flex;
  gap:12px;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}

h1{
  font-size:20px;
  margin:0;
  font-weight:600;
}

.card{
  background:#fff;
  margin:16px;
  border-radius:12px;
  padding:16px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}

label{
  display:block;
  font-size:15px;
  font-weight:600;
  margin-bottom:8px;
  color:#333;
}

input{
  width:100%;
  padding:12px;
  font-size:16px;
  border:1px solid #d1d1d6;
  border-radius:8px;
  margin-bottom:12px;
  background:#fff;
  -webkit-appearance:none;
}

input:focus{
  outline:none;
  border-color:#0f6cbd;
}

button{
  width:100%;
  padding:14px;
  font-size:16px;
  font-weight:600;
  border:none;
  border-radius:8px;
  background:#0f6cbd;
  color:#fff;
  cursor:pointer;
  -webkit-appearance:none;
  touch-action:manipulation;
  user-select:none;
}

button:active{
  opacity:0.8;
  transform:scale(0.98);
}

#scanMsg{
  margin-top:12px;
  padding:12px;
  border-radius:8px;
  background:#e8f5e9;
  color:#2e7d32;
  font-size:15px;
  text-align:center;
  display:none;
}

#scanMsg.show{
  display:block;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal.show{
  display:flex;
}

.modal .box{
  background:#000;
  color:#fff;
  border-radius:16px;
  width:100%;
  height:100%;
  max-width:500px;
  max-height:90vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  margin:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

.modal header{
  padding:16px;
  background:#1a1a1a;
  font-size:18px;
  font-weight:600;
  position:static;
  flex-shrink:0;
}

#reader{
  flex:1;
  position:relative;
  background:#000;
  overflow:hidden;
}

.modal footer{
  padding:16px;
  background:#1a1a1a;
  display:flex;
  gap:12px;
  flex-shrink:0;
}

.modal footer button{
  background:#fff;
  color:#000;
}

@media(max-width:375px){
  h1{
    font-size:18px;
  }
}
</style>
</head>
<body>

<header>
  <h1>Issue Parts to Job â€“ QR Scan</h1>
</header>

<div class="card">
  <label>Job</label>
  <input id="jobInput" type="text" placeholder="Scan or enter job number" autocomplete="off">
  <button id="jobCamBtn">ðŸ“· Scan Job QR Code</button>
</div>

<div class="card">
  <label>Part</label>
  <input id="scanInput" type="text" placeholder="Scan or enter part number" autocomplete="off">
  <button id="partCamBtn">ðŸ“· Scan Part QR Code</button>
  <div id="scanMsg"></div>
</div>

<div class="modal" id="camModal">
  <div class="box">
    <header>Scanning QR Code</header>
    <div id="reader"></div>
    <footer>
      <button id="closeCam">Cancel</button>
    </footer>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
const $ = id => document.getElementById(id);

let scanMode='job';
let html5QrcodeScanner = null;

function toast(msg){
  const el = $('scanMsg');
  el.textContent=msg;
  el.classList.add('show');
  setTimeout(()=> {
    el.classList.remove('show');
  },3000);
}

$('jobCamBtn').onclick=()=>openScanner('job');
$('partCamBtn').onclick=()=>openScanner('part');
$('closeCam').onclick=stopScanner;

// Close modal on background click
$('camModal').onclick=(e)=>{
  if(e.target === $('camModal')){
    stopScanner();
  }
};

function openScanner(mode){
  scanMode=mode;

  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    alert('Camera requires HTTPS or localhost.');
    return;
  }

  $('camModal').classList.add('show');

  try{
    html5QrcodeScanner = new Html5Qrcode("reader");
    
    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0
    };

    html5QrcodeScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
        handleDecoded(decodedText);
      },
      (errorMessage) => {
        // Ignore scanning errors (they happen continuously while scanning)
      }
    ).catch(err => {
      console.error("Start error:", err);
      stopScanner();
      
      if(err.toString().includes('NotAllowedError')){
        alert("Camera access denied. Please enable camera permissions in Settings.");
      } else if(err.toString().includes('NotFoundError')){
        alert("No camera found on this device.");
      } else {
        alert("Camera error. Please try again.");
      }
    });

  } catch(e) {
    console.error("Scanner error:", e);
    stopScanner();
    alert("Failed to open scanner: " + e.message);
  }
}

function stopScanner(){
  if(html5QrcodeScanner){
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
      $('camModal').classList.remove('show');
    }).catch(err => {
      console.error("Stop error:", err);
      html5QrcodeScanner = null;
      $('camModal').classList.remove('show');
    });
  } else {
    $('camModal').classList.remove('show');
  }
}

function handleDecoded(text){
  // Haptic feedback on iOS
  if(navigator.vibrate){
    navigator.vibrate(100);
  }
  
  stopScanner();

  if(scanMode==='job'){
    $('jobInput').value=text;
    toast("âœ“ Job scanned: "+text);
  }else{
    $('scanInput').value=text;
    toast("âœ“ Part scanned: "+text);
  }
}

// Prevent zoom on double-tap
document.addEventListener('dblclick', (e) => {
  e.preventDefault();
}, { passive: false });
</script>

</body>
</html>
