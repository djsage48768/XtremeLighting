<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Issue Parts to Job - QR Scan</title>

<style>
:root{
  --primary:#0f6cbd;
  --ok:#107c10;
  --warn:#ff8c00;
  --err:#d13438;
  --bg:#f7f7f7;
  --card:#fff;
}

*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:var(--bg);
  -webkit-font-smoothing:antialiased;
  -webkit-tap-highlight-color:transparent;
  padding-bottom:calc(80px + env(safe-area-inset-bottom));
}

header{
  padding:16px;
  padding-top:calc(16px + env(safe-area-inset-top));
  background:var(--primary);
  color:#fff;
  position:sticky;
  top:0;
  z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}

h1{
  font-size:20px;
  margin:0;
  font-weight:600;
}

.card{
  background:#fff;
  margin:16px;
  border-radius:12px;
  padding:16px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}

label{
  display:block;
  font-size:13px;
  font-weight:600;
  margin-bottom:6px;
  color:#666;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

select, input{
  width:100%;
  padding:12px;
  font-size:16px;
  border:1px solid #d1d1d6;
  border-radius:8px;
  margin-bottom:12px;
  background:#fff;
  -webkit-appearance:none;
  appearance:none;
}

select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  padding-right:36px;
}

input:focus, select:focus{
  outline:none;
  border-color:var(--primary);
}

button{
  width:100%;
  padding:14px;
  font-size:16px;
  font-weight:600;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
  -webkit-appearance:none;
  touch-action:manipulation;
  user-select:none;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

button:active{
  opacity:0.8;
  transform:scale(0.98);
}

button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

.btn-secondary{
  background:#6c757d;
}

.btn-success{
  background:var(--ok);
}

.btn-danger{
  background:var(--err);
}

.scan-btn{
  margin-bottom:16px;
}

.progress-section{
  margin-top:24px;
}

.progress-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

.progress-header h3{
  margin:0;
  font-size:16px;
  font-weight:600;
}

.progress-stats{
  font-size:14px;
  color:#666;
}

.progress-bar-container{
  height:8px;
  background:#e9ecef;
  border-radius:4px;
  overflow:hidden;
  margin-bottom:16px;
}

.progress-bar{
  height:100%;
  background:var(--ok);
  transition:width 0.3s ease;
}

.parts-list{
  max-height:400px;
  overflow-y:auto;
  border:1px solid #e9ecef;
  border-radius:8px;
}

.part-item{
  padding:12px;
  border-bottom:1px solid #f0f0f0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.part-item:last-child{
  border-bottom:none;
}

.part-item.complete{
  background:#e8f5e9;
}

.part-info{
  flex:1;
}

.part-number{
  font-weight:600;
  font-size:14px;
  color:#333;
  font-family:monospace;
}

.part-desc{
  font-size:12px;
  color:#666;
  margin-top:2px;
}

.part-status{
  display:flex;
  align-items:center;
  gap:8px;
}

.qty-badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:13px;
  font-weight:600;
  white-space:nowrap;
}

.qty-badge.complete{
  background:var(--ok);
  color:#fff;
}

.qty-badge.partial{
  background:var(--warn);
  color:#fff;
}

.qty-badge.pending{
  background:#e9ecef;
  color:#666;
}

.check-icon{
  width:20px;
  height:20px;
  border-radius:50%;
  background:var(--ok);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
}

.toast{
  position:fixed;
  top:calc(70px + env(safe-area-inset-top));
  left:50%;
  transform:translateX(-50%);
  padding:12px 20px;
  border-radius:8px;
  font-size:15px;
  font-weight:500;
  z-index:200;
  max-width:90%;
  text-align:center;
  display:none;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

.toast.show{
  display:block;
  animation:slideDown 0.3s ease;
}

@keyframes slideDown{
  from{ opacity:0; transform:translateX(-50%) translateY(-20px); }
  to{ opacity:1; transform:translateX(-50%) translateY(0); }
}

.toast.success{
  background:var(--ok);
  color:#fff;
}

.toast.error{
  background:var(--err);
  color:#fff;
}

.toast.info{
  background:var(--primary);
  color:#fff;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal.show{
  display:flex;
}

.modal .box{
  background:#000;
  color:#fff;
  border-radius:16px;
  width:100%;
  height:100%;
  max-width:500px;
  max-height:90vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  margin:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

.modal header{
  padding:16px;
  background:#1a1a1a;
  font-size:18px;
  font-weight:600;
  position:static;
  flex-shrink:0;
}

#reader{
  flex:1;
  position:relative;
  background:#000;
  overflow:hidden;
}

.modal footer{
  padding:16px;
  background:#1a1a1a;
  display:flex;
  gap:12px;
  flex-shrink:0;
}

.modal footer button{
  background:#fff;
  color:#000;
}

.bottom-actions{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#fff;
  padding:12px 16px;
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
  box-shadow:0 -2px 8px rgba(0,0,0,.1);
  display:flex;
  gap:12px;
  z-index:50;
}

.bottom-actions button{
  flex:1;
}

.empty-state{
  text-align:center;
  padding:40px 20px;
  color:#999;
}

.empty-state-icon{
  font-size:48px;
  margin-bottom:16px;
}

.scanned-parts{
  margin-top:16px;
}

.scanned-item{
  background:#f8f9fa;
  padding:10px;
  border-radius:6px;
  margin-bottom:8px;
  font-size:13px;
  font-family:monospace;
}

.scanned-item strong{
  display:block;
  margin-bottom:4px;
  color:#333;
}

.scanned-item span{
  color:#666;
  font-size:12px;
}

@media(max-width:375px){
  h1{ font-size:18px; }
  .part-number{ font-size:13px; }
  .part-desc{ font-size:11px; }
}
</style>

</head>
<body>

<header>
  <h1>Issue Parts to Job</h1>
</header>

<div class="card">
  <label>Select Assembly</label>
  <select id="assemblySelect">
    <option value="">-- Select Assembly --</option>
    <option value="01H09000-01 REV U">01H09000-01 REV U</option>
    <option value="01H08000-01 REV U">01H08000-01 REV U</option>
    <option value="01H05000-01 REV T">01H05000-01 REV T</option>
    <option value="01H01000-01 REV H">01H01000-01 REV H</option>
  </select>

<label>Job Number</label>
<input id="jobInput" type="text" placeholder="Scan or enter job number" autocomplete="off">
<button id="jobScanBtn" class="scan-btn">
<span>üì∑</span>
<span>Scan Job QR Code</span>
</button>

  <button id="resumeBtn" class="scan-btn btn-secondary" style="margin-top:-8px;">
    <span>üîÑ</span>
    <span>Resume Partial Pick</span>
  </button>
</div>

<div class="card" id="partsCard" style="display:none;">
  <div class="progress-section">
    <div class="progress-header">
      <h3>Parts Progress</h3>
      <span class="progress-stats" id="progressStats">0 of 0</span>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar" style="width:0%"></div>
    </div>
  </div>

  <button id="partScanBtn" class="scan-btn btn-success">
    <span>üì∑</span>
    <span>Scan Part QR Code</span>
  </button>

  <div id="scannedParts" class="scanned-parts"></div>

  <div class="parts-list" id="partsList"></div>
</div>

<div class="bottom-actions" id="bottomActions" style="display:none;">
  <button id="resetBtn" class="btn-secondary">Reset</button>
  <button id="completeBtn" class="btn-success" disabled>Complete Job</button>
</div>

<div class="toast" id="toast"></div>

<div class="modal" id="scanModal">
  <div class="box">
    <header>Scanning QR Code</header>
    <div id="reader"></div>
    <footer>
      <button id="closeScanner">Cancel</button>
    </footer>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const $ = id => document.getElementById(id);

// BOM Data - embedded from Excel
const BOM_DATA = {
  "01H09000-01 REV U": [
    {"partNumber":"01H09100-01","revision":"A","description":"ASSEMBLY, HEAD END, ACTUATOR MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09300-01","revision":"A","description":"ASSEMBLY, ROD END, ACTUATOR MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09001-01","revision":"G","description":"CYLINDER, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09002-02","revision":"C","description":"PISTON ROD, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09400-03","revision":"A","description":"LOCK PISTON & PINS, ACTR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09004-01","revision":"E","description":"LOCK SEGMENT,ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":4},
    {"partNumber":"01H09005-01","revision":"B","description":"COMPRESSION SPRING,ACTUATOR ASSY,MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09007-01","revision":"B","description":"RETAINING RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09009-01","revision":"A","description":"SHOULDER SCREW","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09010-01","revision":"D","description":"RETAINING RING,ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09011-01","revision":"A","description":"FITTING, COUPLING, ACTUATOR ASSY,MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09012-01","revision":"A","description":"FITTING, COUPLING, ACTUATOR ASSY,MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09013-01","revision":"A","description":"ORIFICE RESTRICTOR, ACTR ASSY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09014-01","revision":"A","description":"FITTING, COUPLING, ACTUATOR ASSY,MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09015-01","revision":"B","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09016-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09017-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09018-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09019-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09020-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09021-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09022-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09023-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09024-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09025-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09026-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09027-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09028-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09029-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09030-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09031-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09032-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09033-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09034-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09035-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09036-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09037-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09038-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09039-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09040-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09041-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09042-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09043-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09044-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09045-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09046-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09047-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09048-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09049-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09050-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09051-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09052-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09053-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09054-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H09055-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H09056-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1}
  ],
  "01H08000-01 REV U": [
    {"partNumber":"01H08200-01","revision":"A","description":"ASSEMBLY, END CAP, ACTUATOR, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08001-01","revision":"A","description":"CYLINDER, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08002-01","revision":"K","description":"PISTON, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08004-01","revision":"H","description":"LOCK SEGMENT, ACTUATOR ASSEMBLY, ML","uom":"EA","qtyRequired":4},
    {"partNumber":"01H08005-01","revision":"B","description":"COMPRESSION SPRING, ACTUATOR ASSEMB","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08006-01","revision":"D","description":"NUT, RETAINER, ACTUATOR ASSEMBLY, M","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08007-01","revision":"E","description":"RETAINING RING, ACTUATOR ASSEMBLY,","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08008-01","revision":"A","description":"COUPLING FITTING, ACTR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08009-01","revision":"A","description":"COUPLING FITTING, ACTR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08010-01","revision":"A","description":"RESTRICTOR, ORIFICE, ACTR ASSY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08011-01","revision":"A","description":"FITTING, COUPLING, ACTR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08012-01","revision":"A","description":"RING, BACK-UP, ACTUATOR ASSEMBLY, M","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08013-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08014-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08015-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08016-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08017-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08018-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08019-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08020-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08021-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08022-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08023-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08024-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08025-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08026-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08027-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08028-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08029-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08030-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08031-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08032-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08033-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08034-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08035-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08036-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08037-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08038-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08039-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08040-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08041-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08042-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08043-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08044-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08045-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08046-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08047-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08048-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08049-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08050-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08051-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08052-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08053-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08054-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":2},
    {"partNumber":"01H08055-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08056-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08057-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08058-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08059-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08060-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08061-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08062-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08063-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08064-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08065-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08066-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08067-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08068-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08069-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08070-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H08071-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MLG","uom":"EA","qtyRequired":1}
  ],
  "01H05000-01 REV T": [
    {"partNumber":"01H05100-01","revision":"A","description":"ASSEMBLY HEAD END,ACTUATOR,MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05200-01","revision":"A","description":"ASSEMBLY, END CAP, ACTUATOR,MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05300-02","revision":"A","description":"ASSEMBLY ROD END,ACTUATOR,MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05001-01","revision":"C","description":"CYLINDER, ACTUATOR,ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05002-02","revision":"E","description":"PISTON ROD, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05003-05","revision":"A","description":"PISTON, LOCKING, MLG","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05004-01","revision":"G","description":"LOCK SEGMENT, ACTUATOR ASSEMBLY,MGL","uom":"EA","qtyRequired":4},
    {"partNumber":"01H05005-01","revision":"B","description":"COMPRESSION SPRING,ACTR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05006-01","revision":"D","description":"NUT, RETAINER, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":2},
    {"partNumber":"01H05007-01","revision":"E","description":"RETAINING RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":2},
    {"partNumber":"01H05008-01","revision":"A","description":"FITTING, COUPLING, ACTR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05009-01","revision":"A","description":"FITTING, COUPLING, ACTR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05010-01","revision":"A","description":"ORIFICE RESTRICTOR,ACTR ASSY, MGL","uom":"EA","qtyRequired":2},
    {"partNumber":"01H05011-01","revision":"A","description":"FITTING, COUPLING, ACTR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05012-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":2},
    {"partNumber":"01H05013-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05014-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05015-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05016-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05017-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05018-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05019-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05020-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05021-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05022-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05023-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05024-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05025-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05026-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05027-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05028-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":2},
    {"partNumber":"01H05029-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05030-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05031-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":2},
    {"partNumber":"01H05032-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05033-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05034-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05035-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05036-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05037-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05038-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05039-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05040-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05041-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05042-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05043-01","revision":"A","description":"BACKUP RING, ACTUATOR ASSY, MGL","uom":"EA","qtyRequired":1},
    {"partNumber":"01H05044-01","revision":"A","description":"O-RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":2},
    {"partNumber":"01H05045-01","revision":"A","description":"PISTON RING, ACTUATOR ASSEMBLY, MGL","uom":"EA","qtyRequired":1}
  ],
  "01H01000-01 REV H": [
    {"partNumber":"01H01100-01","revision":"A","description":"HEAD END ASSEMBLY","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01001-01","revision":"E","description":"CYLINDER, ACT. ASSY, SPEED BRAKE","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01003-01","revision":"E","description":"LOCK PISTON","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01004-02","revision":"B","description":"LOCK SEGMENTS","uom":"EA","qtyRequired":4},
    {"partNumber":"01H01005-01","revision":"A","description":"COMPRESSION SPRING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01006-01","revision":"B","description":"HEAD END RETAINER NUT","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01007-01","revision":"E","description":"RETAINING RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01008-01","revision":"A","description":"VALVE FITTING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01009-01","revision":"A","description":"ORIFICE RESTRICTOR","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01011-01","revision":"A","description":"BACK-UP RING","uom":"EA","qtyRequired":2},
    {"partNumber":"01H01012-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01013-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01014-01","revision":"A","description":"PISTON RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01015-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01016-01","revision":"A","description":"PISTON RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01017-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01018-01","revision":"A","description":"PISTON RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01019-01","revision":"A","description":"PISTON RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01020-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01021-01","revision":"A","description":"BACK-UP RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01022-01","revision":"A","description":"BACK-UP RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01023-01","revision":"A","description":"BACK-UP RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01024-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01025-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01026-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01027-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":2},
    {"partNumber":"01H01028-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1},
    {"partNumber":"01H01029-01","revision":"A","description":"O-RING","uom":"EA","qtyRequired":1}
  ]
};

// Application state
let currentAssembly = null;
let currentJob = null;
let currentBOM = [];
let issuedParts = {}; // {partNumber-revision: [{lot, location, bin, scannedAt}]}
let scannerMode = null; // 'job' or 'part'
let html5QrcodeScanner = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  console.log('App initialized');
  console.log('Html5Qrcode available:', typeof Html5Qrcode !== 'undefined');
  console.log('QRCode available:', typeof QRCode !== 'undefined');
  
  $('assemblySelect').addEventListener('change', onAssemblyChange);
  $('jobInput').addEventListener('input', onJobInput);
  $('jobScanBtn').addEventListener('click', () => {
    console.log('Job scan button clicked');
    openScanner('job');
  });
  $('resumeBtn').addEventListener('click', () => {
    console.log('Resume button clicked');
    openScanner('resume');
  });
  $('partScanBtn').addEventListener('click', () => {
    console.log('Part scan button clicked');
    openScanner('part');
  });
  $('closeScanner').addEventListener('click', closeScanner);
  $('resetBtn').addEventListener('click', resetJob);
  $('completeBtn').addEventListener('click', completeJob);
  
  console.log('Event listeners attached');
});

function onAssemblyChange(e) {
  currentAssembly = e.target.value;
  if(currentAssembly && BOM_DATA[currentAssembly]) {
    currentBOM = BOM_DATA[currentAssembly];
    checkReadyState();
  }
}

function onJobInput(e) {
  currentJob = e.target.value.trim();
  checkReadyState();
}

function checkReadyState() {
  if(currentAssembly && currentJob) {
    initializeJob();
  }
}

function initializeJob() {
  // Reset issued parts
  issuedParts = {};
  
  // Show parts card and bottom actions
  $('partsCard').style.display = 'block';
  $('bottomActions').style.display = 'flex';
  
  // Render parts list
  renderPartsList();
  updateProgress();
}

function renderPartsList() {
  const html = currentBOM.map(part => {
    const key = `${part.partNumber}-${part.revision}`;
    const issued = issuedParts[key] || [];
    const qtyIssued = issued.length;
    const qtyRequired = part.qtyRequired;
    const isComplete = qtyIssued >= qtyRequired;
    const isPartial = qtyIssued > 0 && qtyIssued < qtyRequired;
    
    let badgeClass = 'pending';
    if(isComplete) badgeClass = 'complete';
    else if(isPartial) badgeClass = 'partial';
    
    return `
      <div class="part-item ${isComplete ? 'complete' : ''}">
        <div class="part-info">
          <div class="part-number">${part.partNumber} REV ${part.revision}</div>
          <div class="part-desc">${part.description}</div>
        </div>
        <div class="part-status">
          <span class="qty-badge ${badgeClass}">${qtyIssued}/${qtyRequired}</span>
          ${isComplete ? '<span class="check-icon">‚úì</span>' : ''}
        </div>
      </div>
    `;
  }).join('');
  
  $('partsList').innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div>No parts in BOM</div></div>';
}

function updateProgress() {
  let totalRequired = 0;
  let totalIssued = 0;
  
  currentBOM.forEach(part => {
    const key = `${part.partNumber}-${part.revision}`;
    const issued = issuedParts[key] || [];
    totalRequired += part.qtyRequired;
    totalIssued += Math.min(issued.length, part.qtyRequired);
  });
  
  const percentComplete = totalRequired > 0 ? (totalIssued / totalRequired * 100) : 0;
  
  $('progressStats').textContent = `${totalIssued} of ${totalRequired}`;
  $('progressBar').style.width = `${percentComplete}%`;
  
  // Enable complete button if any parts issued
  const hasIssuedParts = totalIssued > 0;
  $('completeBtn').disabled = !hasIssuedParts;
  
  // Update button text based on completion
  if(percentComplete >= 100) {
    $('completeBtn').innerHTML = '<span>‚úì</span><span>Complete Pick</span>';
  } else if(hasIssuedParts) {
    $('completeBtn').innerHTML = '<span>üìã</span><span>Partial Pick</span>';
  } else {
    $('completeBtn').innerHTML = '<span>üìã</span><span>Complete Pick</span>';
  }
  
  // Update scanned parts display
  updateScannedPartsDisplay();
}

function updateScannedPartsDisplay() {
  const scanned = [];
  for(let key in issuedParts) {
    issuedParts[key].forEach(scan => {
      scanned.push({
        key,
        ...scan
      });
    });
  }
  
  // Sort by most recent
  scanned.sort((a, b) => b.scannedAt - a.scannedAt);
  
  if(scanned.length === 0) {
    $('scannedParts').innerHTML = '';
    return;
  }
  
  const html = scanned.slice(0, 5).map(scan => {
    const [partNumber, bomRevision] = scan.key.split('-');
    const revMatch = scan.scannedRevision === scan.bomRevision;
    const revDisplay = revMatch 
      ? `REV ${scan.scannedRevision}` 
      : `REV ${scan.scannedRevision} <span style="color:#ff8c00;">(BOM: ${scan.bomRevision})</span>`;
    
    return `
      <div class="scanned-item">
        <strong>${partNumber} ${revDisplay}</strong>
        <span>Lot: ${scan.lot || 'N/A'} | Bin: ${scan.bin || 'N/A'} | Loc: ${scan.location || 'N/A'}</span>
      </div>
    `;
  }).join('');
  
  $('scannedParts').innerHTML = `<div style="font-weight:600; margin-bottom:8px; font-size:13px;">Recent Scans:</div>` + html;
}

function openScanner(mode) {
  scannerMode = mode;
  
  if(location.protocol !== 'https:' && location.hostname !== 'localhost') {
    showToast('Camera requires HTTPS', 'error');
    return;
  }
  
  // Check if Html5Qrcode is loaded
  if(typeof Html5Qrcode === 'undefined') {
    showToast('Scanner library not loaded. Please refresh the page.', 'error');
    return;
  }
  
  $('scanModal').classList.add('show');
  
  try {
    html5QrcodeScanner = new Html5Qrcode("reader");
    
    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0,
      disableFlip: false
    };
    
    html5QrcodeScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText) => {
        handleScan(decodedText);
      },
      (errorMessage) => {
        // Ignore - these fire constantly during scanning
      }
    ).catch(err => {
      console.error("Scanner error:", err);
      closeScanner();
      
      let msg = 'Failed to start camera';
      if(err.toString().includes('NotAllowedError') || err.name === 'NotAllowedError') {
        msg = 'Camera permission denied. Enable in Settings > Safari > Camera';
      } else if(err.toString().includes('NotFoundError') || err.name === 'NotFoundError') {
        msg = 'No camera found on device';
      } else if(err.toString().includes('NotReadableError') || err.name === 'NotReadableError') {
        msg = 'Camera is in use by another app';
      }
      
      showToast(msg, 'error');
    });
    
  } catch(err) {
    console.error("Scanner init error:", err);
    closeScanner();
    showToast('Scanner initialization failed: ' + err.message, 'error');
  }
}

function closeScanner() {
  $('scanModal').classList.remove('show');
  
  if(html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
    }).catch((err) => {
      console.log('Stop error (expected):', err);
      html5QrcodeScanner = null;
    });
  }
}

function handleScan(qrData) {
  if(navigator.vibrate) {
    navigator.vibrate(100);
  }
  
  closeScanner();
  
  if(scannerMode === 'job') {
    $('jobInput').value = qrData;
    currentJob = qrData;
    showToast('Job scanned: ' + qrData, 'success');
    checkReadyState();
  } else if(scannerMode === 'resume') {
    loadResumeData(qrData);
  } else {
    processPartScan(qrData);
  }
}

function loadResumeData(qrData) {
  try {
    const resumeData = JSON.parse(qrData);
    
    // Validate resume data
    if(!resumeData.assembly || !resumeData.job || !resumeData.issuedParts) {
      showToast('Invalid resume QR code', 'error');
      return;
    }
    
    // Load the data
    currentAssembly = resumeData.assembly;
    currentJob = resumeData.job;
    issuedParts = resumeData.issuedParts;
    
    // Set UI values
    $('assemblySelect').value = currentAssembly;
    $('jobInput').value = currentJob;
    
    // Load BOM
    if(BOM_DATA[currentAssembly]) {
      currentBOM = BOM_DATA[currentAssembly];
      initializeJob();
      showToast('‚úì Partial pick resumed!', 'success');
    } else {
      showToast('Assembly not found in system', 'error');
      resetJob();
    }
    
  } catch(e) {
    console.error('Resume parse error:', e);
    showToast('Failed to load resume data', 'error');
  }
}

function processPartScan(qrData) {
  // Parse QR code data
  // Expected format: partNumber;revision;lot;bin;location (semicolon separated)
  // Example: 01H09010-02;C;ICA6R-0000;10;9H SH4;
  const parts = qrData.split(';').map(s => s.trim());
  
  if(parts.length < 2) {
    showToast('Invalid QR code format', 'error');
    return;
  }
  
  const [partNumber, scannedRevision, lot = '', bin = '', location = ''] = parts;
  
  // Find this part in the BOM by part number (flexible on revision)
  const bomPart = currentBOM.find(p => p.partNumber === partNumber);
  
  if(!bomPart) {
    showToast(`Part ${partNumber} not in BOM`, 'error');
    return;
  }
  
  // Use BOM part's key but track actual scanned revision
  const key = `${bomPart.partNumber}-${bomPart.revision}`;
  
  // Check if already have enough
  if(!issuedParts[key]) {
    issuedParts[key] = [];
  }
  
  if(issuedParts[key].length >= bomPart.qtyRequired) {
    showToast(`Already have ${bomPart.qtyRequired} of ${partNumber}`, 'info');
    return;
  }
  
  // Add the part with actual scanned revision
  issuedParts[key].push({
    scannedRevision,
    bomRevision: bomPart.revision,
    lot,
    location,
    bin,
    scannedAt: Date.now()
  });
  
  const remaining = bomPart.qtyRequired - issuedParts[key].length;
  
  // Show revision info if different
  const revInfo = scannedRevision !== bomPart.revision ? ` (REV ${scannedRevision}, BOM calls for ${bomPart.revision})` : '';
  
  if(remaining > 0) {
    showToast(`‚úì ${partNumber}${revInfo} scanned (${remaining} more needed)`, 'success');
  } else {
    showToast(`‚úì ${partNumber} complete!`, 'success');
  }
  
  // Update UI
  renderPartsList();
  updateProgress();
}

function showToast(message, type = 'info') {
  const toast = $('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function resetJob() {
  if(!confirm('Reset this job? All scanned parts will be cleared.')) {
    return;
  }
  
  currentAssembly = null;
  currentJob = null;
  currentBOM = [];
  issuedParts = {};
  
  $('assemblySelect').value = '';
  $('jobInput').value = '';
  $('partsCard').style.display = 'none';
  $('bottomActions').style.display = 'none';
  
  showToast('Job reset', 'info');
}

function completeJob() {
  // Check completion status
  let totalRequired = 0;
  let totalIssued = 0;
  let missingParts = [];
  
  currentBOM.forEach(part => {
    const key = `${part.partNumber}-${part.revision}`;
    const issued = issuedParts[key] || [];
    const qtyIssued = issued.length;
    const qtyNeeded = part.qtyRequired - qtyIssued;
    
    totalRequired += part.qtyRequired;
    totalIssued += qtyIssued;
    
    if(qtyNeeded > 0) {
      missingParts.push({
        ...part,
        qtyIssued,
        qtyNeeded
      });
    }
  });
  
  const isPartialPick = missingParts.length > 0;
  
  if(isPartialPick) {
    generatePartialPickReport(missingParts, totalIssued, totalRequired);
  } else {
    generateCompletePickReport();
  }
}

async function generatePartialPickReport(missingParts, totalIssued, totalRequired) {
  // Create resume data for QR code
  const resumeData = {
    assembly: currentAssembly,
    job: currentJob,
    issuedParts: issuedParts,
    timestamp: Date.now()
  };
  
  const resumeString = JSON.stringify(resumeData);
  
  // Generate QR code as data URL using QRCode.js
  let qrDataUrl = '';
  try {
    // Create temporary container
    const tempDiv = document.createElement('div');
    const qr = new QRCode(tempDiv, {
      text: resumeString,
      width: 300,
      height: 300,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.L
    });
    
    // Wait a bit for QR to render
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // Get the canvas and convert to data URL
    const canvas = tempDiv.querySelector('canvas');
    if(canvas) {
      qrDataUrl = canvas.toDataURL('image/png');
    }
  } catch(e) {
    console.error('QR generation error:', e);
    qrDataUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
  }
  
  // Generate HTML report
  const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Partial Pick Report - ${currentJob}</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      max-width: 800px; 
      margin: 0 auto;
    }
    .header {
      border-bottom: 3px solid #0f6cbd;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
      color: #0f6cbd;
      font-size: 24px;
    }
    .header .subtitle {
      color: #666;
      margin-top: 5px;
      font-size: 14px;
    }
    .info-box {
      background: #f7f7f7;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .info-label {
      font-weight: bold;
      color: #333;
    }
    .status-warning {
      background: #fff3cd;
      border-left: 4px solid #ff8c00;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .status-warning h3 {
      margin: 0 0 10px 0;
      color: #ff8c00;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th {
      background: #0f6cbd;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
    }
    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .part-number {
      font-family: monospace;
      font-weight: bold;
    }
    .qr-section {
      margin-top: 30px;
      padding: 20px;
      border: 2px dashed #0f6cbd;
      border-radius: 8px;
      text-align: center;
    }
    .qr-section h3 {
      margin-top: 0;
      color: #0f6cbd;
    }
    .qr-section img {
      border: 1px solid #ddd;
      padding: 10px;
      background: white;
    }
    .qr-instructions {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }
    @media print {
      .no-print { display: none; }
    }
  </style>

</head>
<body>
  <div class="header">
    <h1>‚ö†Ô∏è PARTIAL PICK REPORT</h1>
    <div class="subtitle">Some parts are still missing</div>
  </div>

  <div class="info-box">
    <div class="info-row">
      <span class="info-label">Assembly:</span>
      <span>${currentAssembly}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Job Number:</span>
      <span>${currentJob}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Date:</span>
      <span>${new Date().toLocaleString()}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Progress:</span>
      <span>${totalIssued} of ${totalRequired} parts picked (${Math.round(totalIssued/totalRequired*100)}%)</span>
    </div>
  </div>

  <div class="status-warning">
    <h3>Missing Parts (${missingParts.length})</h3>
    <p>The following parts still need to be picked to complete this job:</p>
  </div>

  <table>
    <thead>
      <tr>
        <th>Part Number</th>
        <th>Rev</th>
        <th>Description</th>
        <th>Picked</th>
        <th>Needed</th>
        <th>Still Required</th>
      </tr>
    </thead>
    <tbody>
      ${missingParts.map(part => `
        <tr>
          <td class="part-number">${part.partNumber}</td>
          <td>${part.revision}</td>
          <td>${part.description}</td>
          <td>${part.qtyIssued}</td>
          <td>${part.qtyRequired}</td>
          <td style="font-weight:bold; color:#d13438;">${part.qtyNeeded}</td>
        </tr>
      `).join('')}
    </tbody>
  </table>

  <div class="qr-section">
    <h3>Resume This Pick Later</h3>
    <img src="${qrDataUrl}" alt="Resume QR Code" />
    <div class="qr-instructions">
      <strong>Scan this QR code</strong> to resume picking where you left off.<br>
      This will reload your progress and show only the remaining parts.
    </div>
  </div>

  <div style="margin-top: 30px; text-align: center; color: #999; font-size: 12px;">
    Generated by Parts Issuance System
  </div>
</body>
</html>
  `;

printReport(html, `Partial_Pick_${currentJob}_${Date.now()}`);
}

function generateCompletePickReport() {
// Build picked parts list
const pickedParts = [];

currentBOM.forEach(part => {
const key = `${part.partNumber}-${part.revision}`;
const issued = issuedParts[key] || [];

```
issued.forEach((scan, idx) => {
  pickedParts.push({
    ...part,
    scanNumber: idx + 1,
    ...scan
  });
});
```

});

const html = `

<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">
  <title>Complete Pick Report - ${currentJob}</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      max-width: 900px; 
      margin: 0 auto;
    }
    .header {
      border-bottom: 3px solid #107c10;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
      color: #107c10;
      font-size: 24px;
    }
    .header .subtitle {
      color: #666;
      margin-top: 5px;
      font-size: 14px;
    }
    .info-box {
      background: #f7f7f7;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .info-label {
      font-weight: bold;
      color: #333;
    }
    .status-success {
      background: #e8f5e9;
      border-left: 4px solid #107c10;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .status-success h3 {
      margin: 0 0 10px 0;
      color: #107c10;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 12px;
    }
    th {
      background: #107c10;
      color: white;
      padding: 8px;
      text-align: left;
      font-weight: 600;
    }
    td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .part-number {
      font-family: monospace;
      font-weight: bold;
    }
    .rev-mismatch {
      color: #ff8c00;
      font-weight: bold;
    }
    @media print {
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚úÖ COMPLETE PICK REPORT</h1>
    <div class="subtitle">All parts successfully picked</div>
  </div>

  <div class="info-box">
    <div class="info-row">
      <span class="info-label">Assembly:</span>
      <span>${currentAssembly}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Job Number:</span>
      <span>${currentJob}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Date:</span>
      <span>${new Date().toLocaleString()}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Total Parts:</span>
      <span>${pickedParts.length} parts</span>
    </div>
  </div>

  <div class="status-success">
    <h3>‚úì Pick Complete</h3>
    <p>All required parts have been successfully picked and issued to this job.</p>
  </div>

  <table>
    <thead>
      <tr>
        <th>Part Number</th>
        <th>BOM Rev</th>
        <th>Scanned Rev</th>
        <th>Description</th>
        <th>Lot</th>
        <th>Bin</th>
        <th>Location</th>
      </tr>
    </thead>
    <tbody>
      ${pickedParts.map(part => {
        const revMismatch = part.scannedRevision !== part.bomRevision;
        return `
        <tr>
          <td class="part-number">${part.partNumber}</td>
          <td>${part.bomRevision}</td>
          <td class="${revMismatch ? 'rev-mismatch' : ''}">${part.scannedRevision}${revMismatch ? ' ‚ö†Ô∏è' : ''}</td>
          <td>${part.description}</td>
          <td>${part.lot || 'N/A'}</td>
          <td>${part.bin || 'N/A'}</td>
          <td>${part.location || 'N/A'}</td>
        </tr>
      `}).join('')}
    </tbody>
  </table>

  <div style="margin-top: 30px; text-align: center; color: #999; font-size: 12px;">
    Generated by Parts Issuance System
  </div>
</body>
</html>
  `;

printReport(html, `Complete_Pick_${currentJob}_${Date.now()}`);
}

function printReport(htmlContent, filename) {
// Open print window
const printWindow = window.open(‚Äô‚Äô, ‚Äò_blank‚Äô);
printWindow.document.write(htmlContent);
printWindow.document.close();

// Wait for content to load then print
printWindow.onload = function() {
setTimeout(() => {
printWindow.print();
}, 250);
};

showToast(‚ÄòReport generated - check print dialog‚Äô, ‚Äòsuccess‚Äô);

// Don‚Äôt auto-reset after partial pick, do reset after complete pick
const isComplete = htmlContent.includes(‚ÄòCOMPLETE PICK REPORT‚Äô);
if(isComplete) {
setTimeout(() => {
if(confirm(‚ÄòPick complete! Reset for next job?‚Äô)) {
resetJob();
}
}, 1000);
}
}

// Prevent double-tap zoom
document.addEventListener(‚Äòdblclick‚Äô, (e) => {
e.preventDefault();
}, { passive: false });
</script>

</body>
</html>